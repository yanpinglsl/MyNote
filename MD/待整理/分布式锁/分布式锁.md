## 分布式锁

​       对于一个单机的系统，我们可以通过lock、Mutex等这些常规的加锁方式来实现，然而对于一个分布式集群的系统而言，单纯的本地锁已经无法解决问题，所以就需要用到分布式锁了，通常我们都会引入三方组件或者服务来解决这个问题，比如数据库、Redis、Zookeeper等。

**通常来说，分布式锁要保证互斥性、不死锁、可重入、高可用，高性能、安全性的特点。**

**互斥性：**指的是对于同一个资源，任意时刻，都只有一个客户端能持有锁。

**不死锁：**指的是必须要有锁超时这种机制，保证在出现问题的时候释放锁，不会出现死锁的问题。

**可重入：**指的是对于同一个线程，可以多次重复加锁。

**高性能和高可用：**加锁和解锁需要开销尽可能低，同时也要保证高可用，避免分布式锁失效。

**安全性：**锁只能被持有的客户端删除，不能被其他客户端删除。

## 基于数据库的分布式锁实现



## Redis分布式锁

**1、原理**

​       分布式锁本质上要实现的目标就是在 Redis 里面占一个“茅坑”，当别的进程也要来占时，发现已经有人蹲在那里了，就只好放弃或者稍后再试。占坑一般是使用 setnx(set if not exists) 指令，只允许被一个客户端占坑。先来先占， 用完了，再调用 del 指令释放茅坑。
死锁问题：如果逻辑执行到中间出现异常了，可能会导致 del 指令没有被调用，这样就会陷入死锁，锁永远得不到释放， 解决这个问题我们在拿到锁之后，再给锁加上一个过期时间，比如 5s，这样即使中间出现异常也可以保证 5 秒之后锁会自动释放。

**2、阻塞锁**

具体实现参考LockService

**3、非阻塞锁**

具体实现参考LockService

**4、Redlock红锁**

具体实现参考LockService